version: '3.8'
services:
  db:
    image: docker.io/postgres:13
    container_name: db_container
    network_mode: "host"
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=mysecretpassword
      - POSTGRES_DB=mydatabase

  rocksdb_exporter:
    container_name: rocksdb_exporter
    image: "localhost/rocksdb_exporter:latest"
    network_mode: "host"
    environment:
      - LATEST_URL=https://prod-testnet-us-west-2-chain-data-backup.s3.us-west-2.amazonaws.com/latest
      - EXPORT_CONFIG_FILE_PATH=/config/config.toml
    volumes:
      - ./config/rocksdb-exporter-config.toml:/config/config.toml
      - rocksdb_exporter_snapshot:/rocksdb-exporter/snapshot

  findorad:
    container_name: findorad
    image: localhost/findorad-binary-image:test
    command:
      - 'node'
      - '--enable-snapshot'
      - '--snapshot-mode=external'
      - '--enable-enterprise-web3'
    environment:
      - LEDGER_DIR=/var/ledger
      - TENDERMINT_HOST=0.0.0.0
      - ABCI_HOST=0.0.0.0
      - SERVER_HOST=0.0.0.0
      - LEDGER_HOST=0.0.0.0
      - RUST_LOG=INFO
      - ABCI_LOG_LEVEL="info,abciapp=info,baseapp=info,account=info,ethereum=info,evm=info,eth_rpc=info"
      - ENABLE_LEDGER_SERVICE=true
      - ENABLE_QUERY_SERVICE=true
      - ENABLE_ETH_API_SERVICE=1
      - EVM_CHAIN_ID=2152
      - RUC_LOG_LEVEL=ERROR
      - POSTGRES_URI="postgresql://postgres:mysecretpassword@127.0.0.1:5432/mydatabase?sslmode=disable"
    volumes:
      - findorad_ledger:/var/ledger
      - findorad_tendermint:/root/.tendermint

  web3_service:
    container_name: web3_service
    image: "localhost/enterprise-web3-platform:latest"
    network_mode: "host"
    environment:
      - WEB3_CONFIG_FILE_PATH=/config/config.toml
    ports:
      - "8545:8545"
      - "8546:8546"
    volumes:
      - ./config/web3-service-config.toml:/config/config.toml

volumes:
  db_data:
  findorad_ledger:
  findorad_tendermint:
  rocksdb_exporter_snapshot:
